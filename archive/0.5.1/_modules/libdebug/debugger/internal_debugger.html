
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>libdebug.debugger.internal_debugger &#8212; libdebug 0.5.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/code-tabs.css?v=1bc26e2f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../../_static/documentation_options.js?v=b9afe91b"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/code-tabs.js?v=c983d12e"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/libdebug/debugger/internal_debugger';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">libdebug 0.5.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../basic_features.html">
    Basic Features
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../breakpoints.html">
    Breakpoints
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../handle_syscalls.html">
    Syscalls
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../catch_signals.html">
    Signals
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../multithreading.html">
    Multithreading
  </a>
</li>

            <li class="nav-item dropdown pst-header-nav-item">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class="nav-item ">
  <a class="nav-link dropdown-item nav-internal" href="../../../quality_of_life.html">
    Quality of Life
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-internal" href="../../../logging.html">
    Logging
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-internal" href="../../../libdebug.html">
    libdebug package
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../basic_features.html">
    Basic Features
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../breakpoints.html">
    Breakpoints
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../handle_syscalls.html">
    Syscalls
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../catch_signals.html">
    Signals
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../multithreading.html">
    Multithreading
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../quality_of_life.html">
    Quality of Life
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../logging.html">
    Logging
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../../libdebug.html">
    libdebug package
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">libdebug.deb...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for libdebug.debugger.internal_debugger</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># This file is part of libdebug Python library (https://github.com/libdebug/libdebug).</span>
<span class="c1"># Copyright (c) 2023-2024 Roberto Alessandro Bertolini, Gabriele Digregorio, Francesco Panebianco. All rights reserved.</span>
<span class="c1"># Licensed under the MIT license. See LICENSE file in the project root for details.</span>
<span class="c1">#</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGKILL</span><span class="p">,</span> <span class="n">SIGSTOP</span><span class="p">,</span> <span class="n">SIGTRAP</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">current_thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>

<span class="kn">import</span> <span class="nn">psutil</span>

<span class="kn">from</span> <span class="nn">libdebug.architectures.syscall_hijacking_provider</span> <span class="kn">import</span> <span class="n">syscall_hijacking_provider</span>
<span class="kn">from</span> <span class="nn">libdebug.builtin.antidebug_syscall_handler</span> <span class="kn">import</span> <span class="n">on_enter_ptrace</span><span class="p">,</span> <span class="n">on_exit_ptrace</span>
<span class="kn">from</span> <span class="nn">libdebug.builtin.pretty_print_syscall_handler</span> <span class="kn">import</span> <span class="n">pprint_on_enter</span><span class="p">,</span> <span class="n">pprint_on_exit</span>
<span class="kn">from</span> <span class="nn">libdebug.data.breakpoint</span> <span class="kn">import</span> <span class="n">Breakpoint</span>
<span class="kn">from</span> <span class="nn">libdebug.data.memory_view</span> <span class="kn">import</span> <span class="n">MemoryView</span>
<span class="kn">from</span> <span class="nn">libdebug.data.signal_catcher</span> <span class="kn">import</span> <span class="n">SignalCatcher</span>
<span class="kn">from</span> <span class="nn">libdebug.data.syscall_handler</span> <span class="kn">import</span> <span class="n">SyscallHandler</span>
<span class="kn">from</span> <span class="nn">libdebug.debugger.internal_debugger_instance_manager</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">extend_internal_debugger</span><span class="p">,</span>
    <span class="n">link_to_internal_debugger</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">libdebug.interfaces.interface_helper</span> <span class="kn">import</span> <span class="n">provide_debugging_interface</span>
<span class="kn">from</span> <span class="nn">libdebug.liblog</span> <span class="kn">import</span> <span class="n">liblog</span>
<span class="kn">from</span> <span class="nn">libdebug.state.resume_context</span> <span class="kn">import</span> <span class="n">ResumeContext</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.debugger_wrappers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">background_alias</span><span class="p">,</span>
    <span class="n">change_state_function_process</span><span class="p">,</span>
    <span class="n">change_state_function_thread</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.debugging_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_absolute_address</span><span class="p">,</span>
    <span class="n">normalize_and_validate_address</span><span class="p">,</span>
    <span class="n">resolve_symbol_in_maps</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.libcontext</span> <span class="kn">import</span> <span class="n">libcontext</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.print_style</span> <span class="kn">import</span> <span class="n">PrintStyle</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.signal_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">resolve_signal_name</span><span class="p">,</span>
    <span class="n">resolve_signal_number</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">libdebug.utils.syscall_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_all_syscall_numbers</span><span class="p">,</span>
    <span class="n">resolve_syscall_name</span><span class="p">,</span>
    <span class="n">resolve_syscall_number</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Callable</span>

    <span class="kn">from</span> <span class="nn">libdebug.data.memory_map</span> <span class="kn">import</span> <span class="n">MemoryMap</span>
    <span class="kn">from</span> <span class="nn">libdebug.interfaces.debugging_interface</span> <span class="kn">import</span> <span class="n">DebuggingInterface</span>
    <span class="kn">from</span> <span class="nn">libdebug.state.thread_context</span> <span class="kn">import</span> <span class="n">ThreadContext</span>
    <span class="kn">from</span> <span class="nn">libdebug.utils.pipe_manager</span> <span class="kn">import</span> <span class="n">PipeManager</span>

<span class="n">THREAD_TERMINATE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">GDB_GOBACK_LOCATION</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;utils&quot;</span> <span class="o">/</span> <span class="s2">&quot;gdb.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>


<div class="viewcode-block" id="InternalDebugger">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger">[docs]</a>
<span class="k">class</span> <span class="nc">InternalDebugger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that holds the global debugging state.&quot;&quot;&quot;</span>

    <span class="n">aslr_enabled</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flag that indicates if ASLR is enabled or not.&quot;&quot;&quot;</span>

    <span class="n">argv</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The command line arguments of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The environment variables of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">escape_antidebug</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flag that indicates if the debugger should escape anti-debugging techniques.&quot;&quot;&quot;</span>

    <span class="n">autoreach_entrypoint</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flag that indicates if the debugger should automatically reach the entry point of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">auto_interrupt_on_command</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flag that indicates if the debugger should automatically interrupt the debugged process when a command is issued.&quot;&quot;&quot;</span>

    <span class="n">breakpoints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Breakpoint</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dictionary of all the breakpoints set on the process.</span>
<span class="sd">    Key: the address of the breakpoint.&quot;&quot;&quot;</span>

    <span class="n">handled_syscalls</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">SyscallHandler</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dictionary of all the syscall handled in the process.</span>
<span class="sd">    Key: the syscall number.&quot;&quot;&quot;</span>

    <span class="n">caught_signals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">SignalCatcher</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A dictionary of all the signals caught in the process.</span>
<span class="sd">    Key: the signal number.&quot;&quot;&quot;</span>

    <span class="n">signals_to_block</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The signals to not forward to the process.&quot;&quot;&quot;</span>

    <span class="n">syscalls_to_pprint</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The syscalls to pretty print.&quot;&quot;&quot;</span>

    <span class="n">syscalls_to_not_pprint</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The syscalls to not pretty print.&quot;&quot;&quot;</span>

    <span class="n">threads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ThreadContext</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A list of all the threads of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">process_id</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The PID of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">pipe_manager</span><span class="p">:</span> <span class="n">PipeManager</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The pipe manager used to communicate with the debugged process.&quot;&quot;&quot;</span>

    <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryView</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The memory view of the debugged process.&quot;&quot;&quot;</span>

    <span class="n">debugging_interface</span><span class="p">:</span> <span class="n">DebuggingInterface</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The debugging interface used to communicate with the debugged process.&quot;&quot;&quot;</span>

    <span class="n">instanced</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether the process was started and has not been killed yet.&quot;&quot;&quot;</span>

    <span class="n">pprint_syscalls</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A flag that indicates if the debugger should pretty print syscalls.&quot;&quot;&quot;</span>

    <span class="n">resume_context</span><span class="p">:</span> <span class="n">ResumeContext</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context that indicates if the debugger should resume the debugged process.&quot;&quot;&quot;</span>

    <span class="n">_polling_thread</span><span class="p">:</span> <span class="n">Thread</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The background thread used to poll the process for state change.&quot;&quot;&quot;</span>

    <span class="n">_polling_thread_command_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The queue used to send commands to the background thread.&quot;&quot;&quot;</span>

    <span class="n">_polling_thread_response_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">|</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The queue used to receive responses from the background thread.&quot;&quot;&quot;</span>

    <span class="n">_is_running</span><span class="p">:</span> <span class="nb">bool</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The overall state of the debugged process. True if the process is running, False otherwise.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the context.&quot;&quot;&quot;</span>
        <span class="c1"># These must be reinitialized on every call to &quot;debugger&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aslr_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoreach_entrypoint</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escape_antidebug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caught_signals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_pprint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_not_pprint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals_to_block</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pprint_syscalls</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_context</span> <span class="o">=</span> <span class="n">ResumeContext</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

<div class="viewcode-block" id="InternalDebugger.clear">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reinitializes the context, so it is ready for a new run.&quot;&quot;&quot;</span>
        <span class="c1"># These must be reinitialized on every call to &quot;run&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caught_signals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_pprint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_not_pprint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals_to_block</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pprint_syscalls</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_context</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.start_up">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.start_up">[docs]</a>
    <span class="k">def</span> <span class="nf">start_up</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts up the context.&quot;&quot;&quot;</span>

        <span class="c1"># The context is linked to itself</span>
        <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_processing_thread</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">extend_internal_debugger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span> <span class="o">=</span> <span class="n">provide_debugging_interface</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">MemoryView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_peek_memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poke_memory</span><span class="p">)</span></div>


<div class="viewcode-block" id="InternalDebugger.start_processing_thread">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.start_processing_thread">[docs]</a>
    <span class="k">def</span> <span class="nf">start_processing_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the thread that will poll the traced process for state change.&quot;&quot;&quot;</span>
        <span class="c1"># Set as daemon so that the Python interpreter can exit even if the thread is still running</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_function</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;libdebug__polling_thread&quot;</span><span class="p">,</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_background_invalid_call</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raises an error when an invalid call is made in background mode.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;This method is not available in a callback.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="InternalDebugger.run">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the process and waits for it to stop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No binary file specified.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not executable.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Process already running, stopping it before restarting.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Polling thread command queue not empty.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_run</span><span class="p">,</span> <span class="p">()))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_antidebug</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Enabling anti-debugging escape mechanism.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_antidebug_escaping</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something went wrong during pipe initialization.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span></div>


<div class="viewcode-block" id="InternalDebugger.attach">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.attach">[docs]</a>
    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches to an existing process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Process already running, stopping it before restarting.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Polling thread command queue not empty.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_attach</span><span class="p">,</span> <span class="p">(</span><span class="n">pid</span><span class="p">,)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.detach">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.detach">[docs]</a>
    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detaches from the process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process not running, cannot detach.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_detach</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.kill">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.kill">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Kills the process.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="c1"># This exception might occur if the process has already died</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;OSError raised during kill&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_kill</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipe_manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.terminate">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.terminate">[docs]</a>
    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Terminates the background thread.</span>

<span class="sd">        The debugger object cannot be used after this method is called.</span>
<span class="sd">        This method should only be called to free up resources when the debugger object is no longer needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">THREAD_TERMINATE</span><span class="p">,</span> <span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="InternalDebugger.cont">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.cont">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">cont</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Continues the process.</span>

<span class="sd">        Args:</span>
<span class="sd">            auto_wait (bool, optional): Whether to automatically wait for the process to stop after continuing. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_cont</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_wait</span><span class="p">,</span> <span class="p">()))</span></div>


<div class="viewcode-block" id="InternalDebugger.interrupt">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.interrupt">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interrupts the process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process not running, cannot interrupt.&quot;</span><span class="p">)</span>

        <span class="c1"># We have to ensure that at least one thread is alive before executing the method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;All threads are dead.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resume_context</span><span class="o">.</span><span class="n">force_interrupt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">,</span> <span class="n">SIGSTOP</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.wait">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.wait">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Waits for the process to stop.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process not running, cannot wait.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dead</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="c1"># Most of the time the function returns here, as there was a wait already</span>
            <span class="c1"># queued by the previous command</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_wait</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.maps">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.maps">[docs]</a>
    <span class="k">def</span> <span class="nf">maps</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">MemoryMap</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the memory maps of the process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">maps</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.print_maps">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.print_maps">[docs]</a>
    <span class="k">def</span> <span class="nf">print_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints the memory maps of the process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">memory_map</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">permissions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">RED</span><span class="si">}{</span><span class="n">memory_map</span><span class="si">}{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">permissions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}{</span><span class="n">memory_map</span><span class="si">}{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;r&quot;</span> <span class="ow">in</span> <span class="n">memory_map</span><span class="o">.</span><span class="n">permissions</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}{</span><span class="n">memory_map</span><span class="si">}{</span><span class="n">PrintStyle</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">memory_map</span><span class="p">)</span></div>


<div class="viewcode-block" id="InternalDebugger.breakpoint">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.breakpoint">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">breakpoint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hardware</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ThreadContext</span><span class="p">,</span> <span class="n">Breakpoint</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Breakpoint</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets a breakpoint at the specified location.</span>

<span class="sd">        Args:</span>
<span class="sd">            position (int | bytes): The location of the breakpoint.</span>
<span class="sd">            hardware (bool, optional): Whether the breakpoint should be hardware-assisted or purely software.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">            condition (str, optional): The trigger condition for the breakpoint. Defaults to None.</span>
<span class="sd">            length (int, optional): The length of the breakpoint. Only for watchpoints. Defaults to 1.</span>
<span class="sd">            callback (Callable[[ThreadContext, Breakpoint], None], optional): A callback to be called when the</span>
<span class="sd">            breakpoint is hit. Defaults to None.</span>
<span class="sd">            file (str, optional): The user-defined backing file to resolve the address in. Defaults to &quot;hybrid&quot;</span>
<span class="sd">            (libdebug will first try to solve the address as an absolute address, then as a relative address w.r.t.</span>
<span class="sd">            the &quot;binary&quot; map file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_symbol</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_address</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">position</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hardware</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Breakpoint condition is supported only for hardware watchpoints.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">condition</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;rw&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid condition for watchpoints. Supported conditions are &#39;w&#39;, &#39;rw&#39;, &#39;x&#39;.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid length for watchpoints. Supported lengths are 1, 2, 4, 8.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">hardware</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>

        <span class="n">bp</span> <span class="o">=</span> <span class="n">Breakpoint</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hardware</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

        <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_breakpoint</span><span class="p">,</span> <span class="p">(</span><span class="n">bp</span><span class="p">,)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="c1"># the breakpoint should have been set by interface</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something went wrong while inserting the breakpoint.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bp</span></div>


<div class="viewcode-block" id="InternalDebugger.catch_signal">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.catch_signal">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">catch_signal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ThreadContext</span><span class="p">,</span> <span class="n">SignalCatcher</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SignalCatcher</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Catch a signal in the target process.</span>

<span class="sd">        Args:</span>
<span class="sd">            signal (int | str): The signal to catch.</span>
<span class="sd">            callback (Callable[[ThreadContext, CaughtSignal], None], optional): A callback to be called when the signal is</span>
<span class="sd">            caught. Defaults to None.</span>
<span class="sd">            recursive (bool, optional): Whether, when the signal is hijacked with another one, the signal catcher</span>
<span class="sd">            associated with the new signal should be considered as well. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CaughtSignal: The CaughtSignal object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">signal_number</span> <span class="o">=</span> <span class="n">resolve_signal_number</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">signal_number</span> <span class="o">=</span> <span class="n">signal</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;signal must be an int or a str&quot;</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">signal_number</span><span class="p">:</span>
            <span class="k">case</span> <span class="n">SIGKILL</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot catch SIGKILL (</span><span class="si">{</span><span class="n">signal_number</span><span class="si">}</span><span class="s2">) as it cannot be caught or ignored. This is a kernel restriction.&quot;</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="n">SIGSTOP</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot catch SIGSTOP (</span><span class="si">{</span><span class="n">signal_number</span><span class="si">}</span><span class="s2">) as it is used by the debugger or ptrace for their internal operations.&quot;</span>
                <span class="p">)</span>
            <span class="k">case</span> <span class="n">SIGTRAP</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot catch SIGTRAP (</span><span class="si">{</span><span class="n">signal_number</span><span class="si">}</span><span class="s2">) as it is used by the debugger or ptrace for their internal operations.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">signal_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">caught_signals</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Signal </span><span class="si">{</span><span class="n">resolve_signal_name</span><span class="p">(</span><span class="n">signal_number</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">signal_number</span><span class="si">}</span><span class="s2">) has already been caught. Overriding it.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recursive</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;recursive must be a boolean&quot;</span><span class="p">)</span>

        <span class="n">catcher</span> <span class="o">=</span> <span class="n">SignalCatcher</span><span class="p">(</span><span class="n">signal_number</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span>

        <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">catcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_catch_signal</span><span class="p">,</span> <span class="p">(</span><span class="n">catcher</span><span class="p">,)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">catcher</span></div>


<div class="viewcode-block" id="InternalDebugger.hijack_signal">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.hijack_signal">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">hijack_signal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">original_signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SignalCatcher</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hijack a signal in the target process.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_signal (int | str): The signal to hijack.</span>
<span class="sd">            new_signal (int | str): The signal to hijack the original signal with.</span>
<span class="sd">            recursive (bool, optional): Whether, when the signal is hijacked with another one, the signal catcher</span>
<span class="sd">            associated with the new signal should be considered as well. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CaughtSignal: The CaughtSignal object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">original_signal_number</span> <span class="o">=</span> <span class="n">resolve_signal_number</span><span class="p">(</span><span class="n">original_signal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_signal_number</span> <span class="o">=</span> <span class="n">original_signal</span>

        <span class="n">new_signal_number</span> <span class="o">=</span> <span class="n">resolve_signal_number</span><span class="p">(</span><span class="n">new_signal</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">new_signal</span>

        <span class="k">if</span> <span class="n">original_signal_number</span> <span class="o">==</span> <span class="n">new_signal_number</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The original signal and the new signal must be different during hijacking.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">SignalCatcher</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;The callback to execute when the signal is received.&quot;&quot;&quot;</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">new_signal_number</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch_signal</span><span class="p">(</span><span class="n">original_signal_number</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span></div>


<div class="viewcode-block" id="InternalDebugger.handle_syscall">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.handle_syscall">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">handle_syscall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">syscall</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">on_enter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ThreadContext</span><span class="p">,</span> <span class="n">SyscallHandler</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_exit</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ThreadContext</span><span class="p">,</span> <span class="n">SyscallHandler</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SyscallHandler</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle a syscall in the target process.</span>

<span class="sd">        Args:</span>
<span class="sd">            syscall (int | str): The syscall name or number to handle.</span>
<span class="sd">            on_enter (Callable[[ThreadContext, HandledSyscall], None], optional): The callback to execute when the</span>
<span class="sd">            syscall is entered. Defaults to None.</span>
<span class="sd">            on_exit (Callable[[ThreadContext, HandledSyscall], None], optional): The callback to execute when the</span>
<span class="sd">            syscall is exited. Defaults to None.</span>
<span class="sd">            recursive (bool, optional): Whether, when the syscall is hijacked with another one, the syscall handler</span>
<span class="sd">            associated with the new syscall should be considered as well. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            HandledSyscall: The HandledSyscall object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">syscall_number</span> <span class="o">=</span> <span class="n">resolve_syscall_number</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">syscall</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">syscall</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recursive</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;recursive must be a boolean&quot;</span><span class="p">)</span>

        <span class="c1"># Check if the syscall is already handled (by the user or by the pretty print handler)</span>
        <span class="k">if</span> <span class="n">syscall_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">[</span><span class="n">syscall_number</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_user</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_user</span><span class="p">:</span>
                <span class="n">liblog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Syscall </span><span class="si">{</span><span class="n">resolve_syscall_name</span><span class="p">(</span><span class="n">syscall_number</span><span class="p">)</span><span class="si">}</span><span class="s2"> is already handled by a user-defined handler. Overriding it.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_user</span> <span class="o">=</span> <span class="n">on_enter</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_user</span> <span class="o">=</span> <span class="n">on_exit</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">recursive</span> <span class="o">=</span> <span class="n">recursive</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">SyscallHandler</span><span class="p">(</span>
                <span class="n">syscall_number</span><span class="p">,</span>
                <span class="n">on_enter</span><span class="p">,</span>
                <span class="n">on_exit</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">recursive</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_handle_syscall</span><span class="p">,</span> <span class="p">(</span><span class="n">handler</span><span class="p">,)),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">handler</span></div>


<div class="viewcode-block" id="InternalDebugger.hijack_syscall">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.hijack_syscall">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">hijack_syscall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">original_syscall</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_syscall</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SyscallHandler</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hijacks a syscall in the target process.</span>

<span class="sd">        Args:</span>
<span class="sd">            original_syscall (int | str): The syscall name or number to hijack.</span>
<span class="sd">            new_syscall (int | str): The syscall name or number to hijack the original syscall with.</span>
<span class="sd">            recursive (bool, optional): Whether, when the syscall is hijacked with another one, the syscall handler</span>
<span class="sd">            associated with the new syscall should be considered as well. Defaults to False.</span>
<span class="sd">            **kwargs: (int, optional): The arguments to pass to the new syscall.</span>

<span class="sd">        Returns:</span>
<span class="sd">            HandledSyscall: The HandledSyscall object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-</span> <span class="n">syscall_hijacking_provider</span><span class="p">()</span><span class="o">.</span><span class="n">allowed_args</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid keyword arguments in syscall hijack&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_syscall</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">original_syscall_number</span> <span class="o">=</span> <span class="n">resolve_syscall_number</span><span class="p">(</span><span class="n">original_syscall</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_syscall_number</span> <span class="o">=</span> <span class="n">original_syscall</span>

        <span class="n">new_syscall_number</span> <span class="o">=</span> <span class="n">resolve_syscall_number</span><span class="p">(</span><span class="n">new_syscall</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_syscall</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">new_syscall</span>

        <span class="k">if</span> <span class="n">original_syscall_number</span> <span class="o">==</span> <span class="n">new_syscall_number</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The original syscall and the new syscall must be different during hijacking.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">on_enter</span> <span class="o">=</span> <span class="n">syscall_hijacking_provider</span><span class="p">()</span><span class="o">.</span><span class="n">create_hijacker</span><span class="p">(</span>
            <span class="n">new_syscall_number</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check if the syscall is already handled (by the user or by the pretty print handler)</span>
        <span class="k">if</span> <span class="n">original_syscall_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">[</span><span class="n">original_syscall_number</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_user</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_user</span><span class="p">:</span>
                <span class="n">liblog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Syscall </span><span class="si">{</span><span class="n">original_syscall_number</span><span class="si">}</span><span class="s2"> is already handled by a user-defined handler. Overriding it.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_user</span> <span class="o">=</span> <span class="n">on_enter</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_user</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">recursive</span> <span class="o">=</span> <span class="n">recursive</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">SyscallHandler</span><span class="p">(</span>
                <span class="n">original_syscall_number</span><span class="p">,</span>
                <span class="n">on_enter</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">recursive</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_handle_syscall</span><span class="p">,</span> <span class="p">(</span><span class="n">handler</span><span class="p">,)),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">handler</span></div>


<div class="viewcode-block" id="InternalDebugger.gdb">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.gdb">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_invalid_call</span><span class="p">)</span>
    <span class="nd">@change_state_function_process</span>
    <span class="k">def</span> <span class="nf">gdb</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">open_in_new_process</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Migrates the current debugging session to GDB.&quot;&quot;&quot;</span>

        <span class="c1"># TODO: not needed?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_gdb</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">open_in_new_process</span> <span class="ow">and</span> <span class="n">libcontext</span><span class="o">.</span><span class="n">terminal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_gdb_in_new_process</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">open_in_new_process</span><span class="p">:</span>
                <span class="n">liblog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot open in a new process. Please configure the terminal in libcontext.terminal.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_gdb_in_shell</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_migrate_from_gdb</span><span class="p">,</span> <span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

        <span class="c1"># We have to ignore a SIGSTOP signal that is sent by GDB</span>
        <span class="c1"># TODO: once we have signal handling, we should remove this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_craft_gdb_migration_command</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crafts the command to migrate to GDB.&quot;&quot;&quot;</span>
        <span class="n">gdb_command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;/bin/gdb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--pid&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">),</span>
            <span class="s2">&quot;-ex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source &quot;</span> <span class="o">+</span> <span class="n">GDB_GOBACK_LOCATION</span><span class="p">,</span>
            <span class="s2">&quot;-ex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ni&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-ex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ni&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">bp_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">bp</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-ex&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">bp</span><span class="o">.</span><span class="n">hardware</span> <span class="ow">and</span> <span class="n">bp</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;rw&quot;</span><span class="p">:</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;awatch *(int</span><span class="si">{</span><span class="n">bp</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2">_t *) </span><span class="si">{</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="si">:</span><span class="s2">0x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">bp</span><span class="o">.</span><span class="n">hardware</span> <span class="ow">and</span> <span class="n">bp</span><span class="o">.</span><span class="n">condition</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;watch *(int</span><span class="si">{</span><span class="n">bp</span><span class="o">.</span><span class="n">length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="si">}</span><span class="s2">_t *) </span><span class="si">{</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="si">:</span><span class="s2">0x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">bp</span><span class="o">.</span><span class="n">hardware</span><span class="p">:</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;hb *&quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;b *&quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instruction_pointer</span> <span class="o">==</span> <span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>
                    <span class="c1"># We have to enqueue an additional continue</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-ex&quot;</span><span class="p">)</span>
                    <span class="n">bp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ni&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gdb_command</span> <span class="o">+</span> <span class="n">bp_args</span>

    <span class="k">def</span> <span class="nf">_open_gdb_in_new_process</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Opens GDB in a new process following the configuration in libcontext.terminal.&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_craft_gdb_migration_command</span><span class="p">()</span>

        <span class="n">initial_pid</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">libcontext</span><span class="o">.</span><span class="n">terminal</span> <span class="o">+</span> <span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">pid</span>

        <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">initial_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Waiting for GDB process to terminate...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">process_iter</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmdline</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">cmdline</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">ZombieProcess</span><span class="p">:</span>
                <span class="c1"># This is a zombie process, which psutil tracks but we cannot interact with</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="n">cmdline</span><span class="p">:</span>
                <span class="n">gdb_process</span> <span class="o">=</span> <span class="n">proc</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;GDB process not found.&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">gdb_process</span><span class="o">.</span><span class="n">is_running</span><span class="p">()</span> <span class="ow">and</span> <span class="n">gdb_process</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">STATUS_ZOMBIE</span><span class="p">:</span>
            <span class="c1"># As the GDB process is in a different group, we do not have the authority to wait on it</span>
            <span class="c1"># So we must keep polling it until it is no longer running</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_open_gdb_in_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open GDB in the current shell.&quot;&quot;&quot;</span>
        <span class="n">gdb_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gdb_pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># This is the child process.</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_craft_gdb_migration_command</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">execv</span><span class="p">(</span><span class="s2">&quot;/bin/gdb&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># This is the parent process.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">gdb_pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Wait for the child process to finish.</span>

    <span class="k">def</span> <span class="nf">_background_step</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes a single instruction of the process.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to step. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threaded_step</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threaded_wait</span><span class="p">()</span>

<div class="viewcode-block" id="InternalDebugger.step">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.step">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_step</span><span class="p">)</span>
    <span class="nd">@change_state_function_thread</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes a single instruction of the process.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to step. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_step</span><span class="p">,</span> <span class="p">(</span><span class="n">thread</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_wait</span><span class="p">,</span> <span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_background_step_until</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes instructions of the process until the specified location is reached.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to step. Defaults to None.</span>
<span class="sd">            position (int | bytes): The location to reach.</span>
<span class="sd">            max_steps (int, optional): The maximum number of steps to execute. Defaults to -1.</span>
<span class="sd">            file (str, optional): The user-defined backing file to resolve the address in. Defaults to &quot;hybrid&quot;</span>
<span class="sd">            (libdebug will first try to solve the address as an absolute address, then as a relative address w.r.t.</span>
<span class="sd">            the &quot;binary&quot; map file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_symbol</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_address</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__threaded_step_until</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">)</span>

<div class="viewcode-block" id="InternalDebugger.step_until">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.step_until">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_step_until</span><span class="p">)</span>
    <span class="nd">@change_state_function_thread</span>
    <span class="k">def</span> <span class="nf">step_until</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span>
        <span class="n">position</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes instructions of the process until the specified location is reached.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to step. Defaults to None.</span>
<span class="sd">            position (int | bytes): The location to reach.</span>
<span class="sd">            max_steps (int, optional): The maximum number of steps to execute. Defaults to -1.</span>
<span class="sd">            file (str, optional): The user-defined backing file to resolve the address in. Defaults to &quot;hybrid&quot;</span>
<span class="sd">            (libdebug will first try to solve the address as an absolute address, then as a relative address w.r.t.</span>
<span class="sd">            the &quot;binary&quot; map file).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_symbol</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_address</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">thread</span><span class="p">,</span>
            <span class="n">address</span><span class="p">,</span>
            <span class="n">max_steps</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_step_until</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_background_finish</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span>
        <span class="n">heuristic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;backtrace&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Continues execution until the current function returns or the process stops.</span>

<span class="sd">        The command requires a heuristic to determine the end of the function. The available heuristics are:</span>
<span class="sd">        - `backtrace`: The debugger will place a breakpoint on the saved return address found on the stack and continue execution on all threads.</span>
<span class="sd">        - `step-mode`: The debugger will step on the specified thread until the current function returns. This will be slower.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to finish.</span>
<span class="sd">            heuristic (str, optional): The heuristic to use. Defaults to &quot;backtrace&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__threaded_finish</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">heuristic</span><span class="p">)</span>

<div class="viewcode-block" id="InternalDebugger.finish">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.finish">[docs]</a>
    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_finish</span><span class="p">)</span>
    <span class="nd">@change_state_function_thread</span>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span> <span class="n">heuristic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;backtrace&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Continues execution until the current function returns or the process stops.</span>

<span class="sd">        The command requires a heuristic to determine the end of the function. The available heuristics are:</span>
<span class="sd">        - `backtrace`: The debugger will place a breakpoint on the saved return address found on the stack and continue execution on all threads.</span>
<span class="sd">        - `step-mode`: The debugger will step on the specified thread until the current function returns. This will be slower.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): The thread to finish.</span>
<span class="sd">            heuristic (str, optional): The heuristic to use. Defaults to &quot;backtrace&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_finish</span><span class="p">,</span> <span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">heuristic</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.enable_pretty_print">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.enable_pretty_print">[docs]</a>
    <span class="k">def</span> <span class="nf">enable_pretty_print</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SyscallHandler</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles a syscall in the target process to pretty prints its arguments and return value.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>

        <span class="n">syscall_numbers</span> <span class="o">=</span> <span class="n">get_all_syscall_numbers</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">syscall_number</span> <span class="ow">in</span> <span class="n">syscall_numbers</span><span class="p">:</span>
            <span class="c1"># Check if the syscall is already handled (by the user or by the pretty print handler)</span>
            <span class="k">if</span> <span class="n">syscall_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="p">[</span><span class="n">syscall_number</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">syscall_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_not_pprint</span> <span class="ow">or</span> <span class="p">[])</span> <span class="ow">and</span> <span class="n">syscall_number</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_pprint</span> <span class="ow">or</span> <span class="n">syscall_numbers</span>
                <span class="p">):</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_pprint</span> <span class="o">=</span> <span class="n">pprint_on_enter</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_pprint</span> <span class="o">=</span> <span class="n">pprint_on_exit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Remove the pretty print handler from previous pretty print calls</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_pprint</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_pprint</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">syscall_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_not_pprint</span> <span class="ow">or</span> <span class="p">[])</span> <span class="ow">and</span> <span class="n">syscall_number</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syscalls_to_pprint</span> <span class="ow">or</span> <span class="n">syscall_numbers</span>
            <span class="p">):</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">SyscallHandler</span><span class="p">(</span>
                    <span class="n">syscall_number</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">pprint_on_enter</span><span class="p">,</span>
                    <span class="n">pprint_on_exit</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

                <span class="c1"># We have to disable the handler since it is not user-defined</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_handle_syscall</span><span class="p">,</span> <span class="p">(</span><span class="n">handler</span><span class="p">,)),</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.disable_pretty_print">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.disable_pretty_print">[docs]</a>
    <span class="k">def</span> <span class="nf">disable_pretty_print</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable the handler for all the syscalls that are pretty printed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>

        <span class="n">installed_handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handled_syscalls</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">installed_handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_pprint</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_pprint</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_user</span> <span class="ow">or</span> <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_user</span><span class="p">:</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_enter_pprint</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">on_exit_pprint</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_unhandle_syscall</span><span class="p">,</span> <span class="p">(</span><span class="n">handler</span><span class="p">,)),</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span></div>


<div class="viewcode-block" id="InternalDebugger.insert_new_thread">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.insert_new_thread">[docs]</a>
    <span class="k">def</span> <span class="nf">insert_new_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a new thread in the context.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread (ThreadContext): the thread to insert.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Thread already registered.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span></div>


<div class="viewcode-block" id="InternalDebugger.set_thread_as_dead">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.set_thread_as_dead">[docs]</a>
    <span class="k">def</span> <span class="nf">set_thread_as_dead</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">thread_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">exit_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exit_signal</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a thread as dead and update its exit code and exit signal.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread_id (int): the ID of the thread to set as dead.</span>
<span class="sd">            exit_code (int, optional): the exit code of the thread.</span>
<span class="sd">            exit_signal (int, optional): the exit signal of the thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">==</span> <span class="n">thread_id</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">set_as_dead</span><span class="p">()</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">_exit_code</span> <span class="o">=</span> <span class="n">exit_code</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">_exit_signal</span> <span class="o">=</span> <span class="n">exit_signal</span>
                <span class="k">break</span></div>


<div class="viewcode-block" id="InternalDebugger.get_thread_by_id">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.get_thread_by_id">[docs]</a>
    <span class="k">def</span> <span class="nf">get_thread_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ThreadContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a thread by its ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            thread_id (int): the ID of the thread to get.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ThreadContext: the thread with the specified ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">==</span> <span class="n">thread_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">thread</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="InternalDebugger.resolve_address">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.resolve_address">[docs]</a>
    <span class="k">def</span> <span class="nf">resolve_address</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">backing_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalizes and validates the specified address.</span>

<span class="sd">        Args:</span>
<span class="sd">            address (int): The address to normalize and validate.</span>
<span class="sd">            backing_file (str): The backing file to resolve the address in.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The normalized and validated address.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the substring `backing_file` is present in multiple backing files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">maps</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">backing_file</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hybrid&quot;</span><span class="p">,</span> <span class="s2">&quot;absolute&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">check_absolute_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">maps</span><span class="p">):</span>
                <span class="c1"># If the address is absolute, we can return it directly</span>
                <span class="k">return</span> <span class="n">address</span>
            <span class="k">elif</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="s2">&quot;absolute&quot;</span><span class="p">:</span>
                <span class="c1"># The address is explicitly an absolute address but we did not find it</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The specified absolute address does not exist. Check the address or specify a backing file.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the address was not found and the backing file is not &quot;absolute&quot;,</span>
                <span class="c1"># we have to assume it is in the main map</span>
                <span class="n">backing_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_full_path</span><span class="p">()</span>
                <span class="n">liblog</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No backing file specified and no corresponding absolute address found for </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2">. Assuming </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">backing_file</span> <span class="o">==</span> <span class="p">(</span><span class="n">full_backing_path</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_full_path</span><span class="p">())</span>
            <span class="ow">or</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
            <span class="ow">or</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_name</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">backing_file</span> <span class="o">=</span> <span class="n">full_backing_path</span>

        <span class="n">filtered_maps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">vmap</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backing_file</span> <span class="ow">in</span> <span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="p">:</span>
                <span class="n">filtered_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
                <span class="n">unique_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The substring </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2"> is present in multiple, different backing files. The address resolution cannot be accurate. The matching backing files are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_files</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_maps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The specified string </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2"> does not correspond to any backing file. The available backing files are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">vmap</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">maps</span><span class="p">))</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">normalize_and_validate_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">filtered_maps</span><span class="p">)</span></div>


<div class="viewcode-block" id="InternalDebugger.resolve_symbol">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.resolve_symbol">[docs]</a>
    <span class="k">def</span> <span class="nf">resolve_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">backing_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolves the address of the specified symbol.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbol (str): The symbol to resolve.</span>
<span class="sd">            backing_file (str): The backing file to resolve the symbol in.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The address of the symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">maps</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="s2">&quot;absolute&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot use `absolute` backing file with symbols.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="c1"># If no explicit backing file is specified, we have to assume it is in the main map</span>
            <span class="n">backing_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_full_path</span><span class="p">()</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No backing file specified for the symbol </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">. Assuming </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">backing_file</span> <span class="o">==</span> <span class="p">(</span><span class="n">full_backing_path</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_full_path</span><span class="p">())</span>
            <span class="ow">or</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="s2">&quot;binary&quot;</span>
            <span class="ow">or</span> <span class="n">backing_file</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_process_name</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">backing_file</span> <span class="o">=</span> <span class="n">full_backing_path</span>

        <span class="n">filtered_maps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">vmap</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">backing_file</span> <span class="ow">in</span> <span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="p">:</span>
                <span class="n">filtered_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vmap</span><span class="p">)</span>
                <span class="n">unique_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The substring </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2"> is present in multiple, different backing files. The address resolution cannot be accurate. The matching backing files are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_files</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_maps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The specified string </span><span class="si">{</span><span class="n">backing_file</span><span class="si">}</span><span class="s2"> does not correspond to any backing file. The available backing files are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vmap</span><span class="o">.</span><span class="n">backing_file</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">vmap</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">maps</span><span class="p">))</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">resolve_symbol_in_maps</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">filtered_maps</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_background_ensure_process_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates the state of the process.&quot;&quot;&quot;</span>
        <span class="c1"># In background mode, there shouldn&#39;t be anything to do here</span>

    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">_background_ensure_process_stopped</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_ensure_process_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates the state of the process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_interrupt_on_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_is_in_background</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">current_thread</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread</span>

    <span class="k">def</span> <span class="nf">__polling_thread_function</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This function is run in a thread. It is used to poll the process for state change.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Wait for the main thread to signal a command to execute</span>
            <span class="n">command</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="n">THREAD_TERMINATE</span><span class="p">:</span>
                <span class="c1"># Signal that the command has been executed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="c1"># Execute the command</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">command</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">return_value</span> <span class="o">=</span> <span class="n">e</span>

            <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

            <span class="c1"># Signal that the command has been executed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">return_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_join_and_check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Wait for the background thread to signal &quot;task done&quot; before returning</span>
        <span class="c1"># We don&#39;t want any asynchronous behaviour here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Check for any exceptions raised by the background thread</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">response</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">_get_process_full_path</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the full path of the process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: the full path of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/proc/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="si">}</span><span class="s2">/exe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlink</span><span class="p">())</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cache</span>
    <span class="k">def</span> <span class="nf">_get_process_name</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: the name of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/proc/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="si">}</span><span class="s2">/comm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_run</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Starting process </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Attaching to process </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Detaching from process </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
                <span class="s2">&quot;Killing process </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">).&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Killing process </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_cont</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
                <span class="s2">&quot;Continuing process </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">).&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Continuing process </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_running</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">cont</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
                <span class="s2">&quot;Waiting for process </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2">) to stop.&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Waiting for process </span><span class="si">%d</span><span class="s2"> to stop.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_id</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dead</span><span class="p">:</span>
                <span class="c1"># All threads are dead</span>
                <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;All threads dead&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resume_context</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_context</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">cont</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_breakpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">bp</span><span class="p">:</span> <span class="n">Breakpoint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Setting breakpoint at 0x</span><span class="si">%x</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">set_breakpoint</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__threaded_catch_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">catcher</span><span class="p">:</span> <span class="n">SignalCatcher</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Setting the catcher for signal </span><span class="si">{</span><span class="n">resolve_signal_name</span><span class="p">(</span><span class="n">catcher</span><span class="o">.</span><span class="n">signal_number</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">catcher</span><span class="o">.</span><span class="n">signal_number</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">set_signal_catcher</span><span class="p">(</span><span class="n">catcher</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__threaded_handle_syscall</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">SyscallHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting the handler for syscall </span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">syscall_number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">set_syscall_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__threaded_unhandle_syscall</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">SyscallHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsetting the handler for syscall </span><span class="si">{</span><span class="n">handler</span><span class="o">.</span><span class="n">syscall_number</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">unset_syscall_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__threaded_step</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Stepping thread </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_running</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_step_until</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">max_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="s2">&quot;Stepping thread </span><span class="si">%s</span><span class="s2"> until 0x</span><span class="si">%x</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">step_until</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">thread</span><span class="p">:</span> <span class="n">ThreadContext</span><span class="p">,</span> <span class="n">heuristic</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">heuristic</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

        <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> finish on thread %s&quot;</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">heuristic</span><span class="o">=</span><span class="n">heuristic</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_stopped</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_gdb</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">migrate_to_gdb</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_migrate_from_gdb</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">migrate_from_gdb</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__threaded_peek_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">peek_memory</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="c1"># TODO: this is only for amd64</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">__threaded_poke_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">int_data</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugging_interface</span><span class="o">.</span><span class="n">poke_memory</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">int_data</span><span class="p">)</span>

    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">__threaded_peek_memory</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_peek_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reads memory from the process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process not running, cannot step.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="c1"># Reading memory while the process is running could lead to concurrency issues</span>
            <span class="c1"># and corrupted values</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
                <span class="s2">&quot;Process is running. Waiting for it to stop before reading memory.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_peek_memory</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span><span class="p">,)),</span>
        <span class="p">)</span>

        <span class="c1"># We cannot call _join_and_check_status here, as we need the return value which might not be an exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_response_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@background_alias</span><span class="p">(</span><span class="n">__threaded_poke_memory</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_poke_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes memory to the process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instanced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Process not running, cannot step.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="c1"># Reading memory while the process is running could lead to concurrency issues</span>
            <span class="c1"># and corrupted values</span>
            <span class="n">liblog</span><span class="o">.</span><span class="n">debugger</span><span class="p">(</span>
                <span class="s2">&quot;Process is running. Waiting for it to stop before writing to memory.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_process_stopped</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_poke_memory</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">)),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_join_and_check_status</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_enable_antidebug_escaping</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enables the anti-debugging escape mechanism.&quot;&quot;&quot;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">SyscallHandler</span><span class="p">(</span>
            <span class="n">resolve_syscall_number</span><span class="p">(</span><span class="s2">&quot;ptrace&quot;</span><span class="p">),</span>
            <span class="n">on_enter_ptrace</span><span class="p">,</span>
            <span class="n">on_exit_ptrace</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">link_to_internal_debugger</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__polling_thread_command_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__threaded_handle_syscall</span><span class="p">,</span> <span class="p">(</span><span class="n">handler</span><span class="p">,)))</span>

        <span class="c1"># Seutp hidden state for the handler</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">_traceme_called</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the state of the process.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the process is running, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span>

<div class="viewcode-block" id="InternalDebugger.set_running">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.set_running">[docs]</a>
    <span class="k">def</span> <span class="nf">set_running</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the state of the process to running.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="InternalDebugger.set_stopped">
<a class="viewcode-back" href="../../../libdebug.debugger.html#libdebug.debugger.internal_debugger.InternalDebugger.set_stopped">[docs]</a>
    <span class="k">def</span> <span class="nf">set_stopped</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">InternalDebugger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the state of the process to stopped.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, Gabriele Digregorio, Roberto Alessandro Bertolini, Francesco Panebianco.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>